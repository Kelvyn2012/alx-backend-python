pipeline {
  agent any
  options { timestamps() }
  parameters {
    string(name: 'BRANCH', defaultValue: 'main', description: 'Git branch to build')
  }
  environment {
    GITHUB_CREDENTIALS_ID = 'github-creds'  // Match your actual credentials ID
    DOCKER_CREDENTIALS_ID = 'docker-hub-creds'  // Docker Hub credentials ID
    IMAGE_NAME = 'kelvyn2012/django-messaging-app' // Docker image name
    REPORT_DIR = 'reports'
    PYTHON_VERSION = '3.10'
    DOCKER_IMAGE = "python:${PYTHON_VERSION}"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${params.BRANCH}"]],  // Use the BRANCH parameter to check out the specified branch
          userRemoteConfigs: [[
            url: 'https://github.com/Kelvyn2012/alx-backend-python.git',
            credentialsId: GITHUB_CREDENTIALS_ID  // Reference your GitHub credentials here
          ]]
        ])
      }
    }
    
    stage('Docker sanity check') {
      steps {
        wrap([$class: 'AnsiColorBuildWrapper', colorMapName: 'xterm']) {
          sh 'docker version'
        }
      }
    }

    // Build Docker image
    stage('Build Docker image') {
      steps {
        wrap([$class: 'AnsiColorBuildWrapper', colorMapName: 'xterm']) {
          script {
            // Build the Docker image for the Django messaging app
            docker.build("${IMAGE_NAME}:${params.BRANCH}-${BUILD_NUMBER}", "-f messaging_app/Dockerfile .")
          }
        }
      }
    }

    // Push Docker image to Docker Hub
    stage('Push Docker image') {
      steps {
        withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
          script {
            // Login to Docker Hub
            sh '''
              echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
            '''
            
            // Push the Docker image to Docker Hub
            docker.push("${IMAGE_NAME}:${params.BRANCH}-${BUILD_NUMBER}")
          }
        }
      }
    }

    stage('Run tests in python:3.10') {
      steps {
        wrap([$class: 'AnsiColorBuildWrapper', colorMapName: 'xterm']) {
          script {
            docker.image(DOCKER_IMAGE).inside('-u 0:0') {
              dir('messaging_app') {
                // Ensure the report directory exists
                sh 'mkdir -p ${REPORT_DIR}'

                // Install dependencies from requirements.txt if it exists
                sh '''
                  if [ -f requirements.txt ]; then
                    echo "Installing dependencies..."
                    pip3 install --upgrade pip
                    pip3 install -r requirements.txt
                  else
                    echo "No requirements.txt found, skipping dependency installation."
                  fi
                '''

                // Install pytest and pytest-cov (for test reporting)
                sh 'pip3 install pytest pytest-cov'

                // Run pytest and generate reports
                sh '''
                  pytest -q --junitxml=${REPORT_DIR}/pytest-junit.xml --cov=. --cov-report=term-missing
                '''
              }
            }
          }
        }
      }
    }
  }
  post {
    always {
      // Handle empty test results gracefully
      junit allowEmptyResults: true, testResults: 'messaging_app/reports/pytest-junit.xml'
      archiveArtifacts artifacts: 'messaging_app/reports/**', fingerprint: true
    }
  }
}
