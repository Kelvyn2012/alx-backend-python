pipeline {
  agent any

  options {
    timestamps()
    ansiColor('xterm')
  }

  parameters {
    string(name: 'BRANCH', defaultValue: 'main', description: 'Git branch to build')
  }

  environment {
    // Change if you used a different credentials ID
    GITHUB_CREDENTIALS_ID = 'github-creds'
    REPORT_DIR = 'reports'
  }

  stages {
    stage('Checkout') {
      steps {
        // Checkout the whole repo so we can enter the messaging_app dir
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${params.BRANCH}"]],
          userRemoteConfigs: [[
            url: 'https://github.com/<your-org>/alx-backend-python.git',
            credentialsId: GITHUB_CREDENTIALS_ID
          ]]
        ])
      }
    }

    stage('Set up Python (ShiningPanda) & Install Deps') {
      steps {
        dir('messaging_app') {
          withPythonEnv('Python 3.10') {
            sh 'python --version'
            // Create an isolated venv to avoid polluting the toolâ€™s base install
            sh 'python -m venv .venv'
            sh '. .venv/bin/activate && python -m pip install --upgrade pip'
            // Install your app deps + pytest (and pytest-html if you want HTML too)
            sh '''
              . .venv/bin/activate
              if [ -f requirements.txt ]; then
                pip install -r requirements.txt
              fi
              pip install pytest pytest-cov
            '''
          }
        }
      }
    }

    stage('Run Tests (pytest)') {
      steps {
        dir('messaging_app') {
          sh 'mkdir -p ${REPORT_DIR}'
          sh '''
            . .venv/bin/activate
            pytest -q \
              --junitxml=${REPORT_DIR}/pytest-junit.xml \
              --cov=. --cov-report=term-missing
          '''
        }
      }
    }
  }

  post {
    always {
      // Publish JUnit results (visible in Jenkins "Tests" tab)
      junit allowEmptyResults: true, testResults: 'messaging_app/reports/pytest-junit.xml'
      // Keep the raw reports as build artifacts
      archiveArtifacts artifacts: 'messaging_app/reports/**', fingerprint: true
    }
  }
}
